#=============================================================================================================================
# Group Assignment (Analytics II)
# Dataset: Kaggle - Microsoft Malware Detection 2
# Purpose: Association Rules
#=============================================================================================================================

#---- Setting Up ----
setwd("C:/Users/User/Desktop")

library(arules)
library(arulesViz)
library(ggcharts)
library(dplyr)
library(tidyr)

malware <- read.csv("malware.csv")
names(malware)

#---- Association Rules in malware1 ----
malware1 <- subset(malware, select = c(Census_ProcessorCoreCount,
                                       Processor,
                                       Firewall,
                                       Census_PrimaryDiskTypeName,
                                       Census_SystemVolumeTotalCapacity,
                                       Census_HasOpticalDiskDrive,
                                       Census_TotalPhysicalRAM,
                                       Census_InternalPrimaryDiagonalDisplaySizeInInches,
                                       Census_IsTouchEnabled,
                                       HasDetections))

dim(malware1)
# [1] 500998     10

names(malware1)
# [1] "Census_ProcessorCoreCount"                         "Processor"                                        
# [3] "Firewall"                                          "Census_PrimaryDiskTypeName"                       
# [5] "Census_SystemVolumeTotalCapacity"                  "Census_HasOpticalDiskDrive"                       
# [7] "Census_TotalPhysicalRAM"                           "Census_InternalPrimaryDiagonalDisplaySizeInInches"
# [9] "Census_IsTouchEnabled"                             "HasDetections"  

colSums(is.na(malware1))
# Census_ProcessorCoreCount                                         Processor 
#                     2273                                                 0 
# Firewall                        Census_PrimaryDiskTypeName 
#      582                                                 0 
# Census_SystemVolumeTotalCapacity                        Census_HasOpticalDiskDrive 
#                             3022                                                 0 
# Census_TotalPhysicalRAM     Census_InternalPrimaryDiagonalDisplaySizeInInches 
#                   4491                                                   1747 
# Census_IsTouchEnabled                                     HasDetections 
#                    0                                                 0 
# HasDetection 
#            0 

# Convert to Factor
typeof(malware1$HasDetections)
malware1$HasDetection <- as.character(malware1$HasDetection)
malware1$HasDetection <- as.factor(malware1$HasDetection)

# Drop all NA values
malware1 <- malware1 %>% drop_na(Census_ProcessorCoreCount, 
                                 Firewall, Census_SystemVolumeTotalCapacity, 
                                 Census_TotalPhysicalRAM, Census_InternalPrimaryDiagonalDisplaySizeInInches)

colSums(is.na(malware1))

# Setting all data as Factor
malware1[sapply(malware1, is.character)] <- lapply(malware1[sapply(malware1, is.character)], 
                                           as.factor)

# Changing data to transactions
malware1 <- as(data.frame(lapply(malware1, as.character), stringsAsFactors=T), "transactions")
summary(malware1)
ar1 <- apriori(data = malware1, parameter = list(minlen = 2, supp=0.001, conf = 0.3, target = "rules"))

summary(ar1)
inspect(ar1[1:10])
#      lhs                                          rhs                              support     confidence lift      count
# [1]  {Census_SystemVolumeTotalCapacity=953251} => {Census_IsTouchEnabled=0}        0.001004209 0.9860835  1.1295947 496  
# [2]  {Census_SystemVolumeTotalCapacity=953251} => {Processor=x64}                  0.001018381 1.0000000  1.0988060 503  
# [3]  {Census_SystemVolumeTotalCapacity=953251} => {Firewall=1}                     0.001002185 0.9840954  1.0048549 495  
# [4]  {Census_SystemVolumeTotalCapacity=58498}  => {Census_PrimaryDiskTypeName=SSD} 0.001018381 0.9980159  3.4900207 503  
# [5]  {Census_SystemVolumeTotalCapacity=58498}  => {Census_HasOpticalDiskDrive=0}   0.001012308 0.9920635  1.0756581 500  
# [6]  {Census_SystemVolumeTotalCapacity=58498}  => {Firewall=1}                     0.001016357 0.9960317  1.0170430 502  
# [7]  {Census_SystemVolumeTotalCapacity=28546}  => {Census_PrimaryDiskTypeName=SSD} 0.001046726 1.0000000  3.4969591 517  
# [8]  {Census_SystemVolumeTotalCapacity=28546}  => {Firewall=1}                     0.001042677 0.9961315  1.0171449 515  
# [9]  {Census_SystemVolumeTotalCapacity=149500} => {Census_IsTouchEnabled=0}        0.001038628 0.9734345  1.1151049 513  
# [10] {Census_SystemVolumeTotalCapacity=149500} => {Firewall=1}                     0.001024455 0.9601518  0.9804062 506  


malware1rules <- apriori(malware1, 
                       parameter=list(support =0.001, confidence =0.5, minlen=2, maxlen=2), 
                       appearance = list(lhs=c("HasDetections=0", "HasDetections=1"), 
                                         default="rhs"))

inspect(malware1rules[1:14])
#      lhs                  rhs                              support   confidence lift      count 
# [1]  {HasDetections=1} => {HasDetection=1}                 0.4996346 1.0000000  2.0014628 246780
# [2]  {HasDetections=1} => {Census_ProcessorCoreCount=4}    0.3107845 0.6220237  1.0159438 153503
# [3]  {HasDetections=1} => {Census_PrimaryDiskTypeName=HDD} 0.3304071 0.6612975  1.0138523 163195
# [4]  {HasDetections=1} => {Census_IsTouchEnabled=0}        0.4431620 0.8869722  1.0160591 218887
# [5]  {HasDetections=1} => {Processor=x64}                  0.4654429 0.9315666  1.0236110 229892
# [6]  {HasDetections=1} => {Census_HasOpticalDiskDrive=0}   0.4582858 0.9172421  0.9945320 226357
# [7]  {HasDetections=1} => {Firewall=1}                     0.4893779 0.9794716  1.0001335 241714
# [8]  {HasDetections=0} => {HasDetection=0}                 0.5003654 1.0000000  1.9985393 247141
# [9]  {HasDetections=0} => {Census_ProcessorCoreCount=4}    0.3014774 0.6025144  0.9840795 148906
# [10] {HasDetections=0} => {Census_PrimaryDiskTypeName=HDD} 0.3218551 0.6432401  0.9861680 158971
# [11] {HasDetections=0} => {Census_IsTouchEnabled=0}        0.4297914 0.8589550  0.9839644 212283
# [12] {HasDetections=0} => {Processor=x64}                  0.4446359 0.8886223  0.9764235 219615
# [13] {HasDetections=0} => {Census_HasOpticalDiskDrive=0}   0.4639993 0.9273208  1.0054600 229179
# [14] {HasDetections=0} => {Firewall=1}                     0.4899630 0.9792102  0.9998667 242003

#---- Association Rules in malware ----

colSums(is.na(malware))

# ï..EngineVersion                                        AppVersion 
# 0                                                 0 
# AvSigVersion                                  IsSxsPassiveMode 
# 0                                                 0 
# AVProductsInstalled                                 AVProductsEnabled 
# 1125                                              1125 
# HasTpm                                         Processor 
# 0                                                 0 
# OsBuild                                        SkuEdition 
# 0                                                 0 
# IsProtected                                             SMode 
# 1125                                             30338 
# SmartScreen                                          Firewall 
# 0                                               582 
# Census_MDC2FormFactor                         Census_ProcessorCoreCount 
# 0                                              2273 
# Census_PrimaryDiskTotalCapacity                        Census_PrimaryDiskTypeName 
# 3022                                                 0 
# Census_SystemVolumeTotalCapacity                        Census_HasOpticalDiskDrive 
# 3022                                                 0 
# Census_TotalPhysicalRAM Census_InternalPrimaryDiagonalDisplaySizeInInches 
# 4491                                              1747 
# Census_InternalPrimaryDisplayResolutionHorizontal   Census_InternalPrimaryDisplayResolutionVertical 
# 1741                                              1741 
# Census_OSSkuName                          Census_OSInstallTypeName 
# 0                                                 0 
# Census_OSWUAutoUpdateOptionsName                        Census_IsSecureBootEnabled 
# 0                                                 0 
# Census_IsTouchEnabled                               Census_IsPenCapable 
# 0                                                 0 
# Census_IsAlwaysOnAlwaysConnectedCapable                                      Wdft_IsGamer 
# 3868                                             17669 
# HasDetections 
# 0

# Omitting all the NA values
malware <- malware %>% drop_na(AVProductsInstalled , 
                               AVProductsEnabled, IsProtected, SMode,
                               Firewall, Census_ProcessorCoreCount, Census_PrimaryDiskTotalCapacity,
                               Census_SystemVolumeTotalCapacity, Census_TotalPhysicalRAM,
                               Census_InternalPrimaryDiagonalDisplaySizeInInches, 
                               Census_InternalPrimaryDisplayResolutionHorizontal,
                               Census_InternalPrimaryDisplayResolutionVertical,
                               Census_IsAlwaysOnAlwaysConnectedCapable,
                               Wdft_IsGamer)
colSums(is.na(malware))

dim(malware)
# [1] 447430     33

malware[sapply(malware, is.character)] <- lapply(malware[sapply(malware, is.character)], 
                                                   as.factor)

malware <- as(data.frame(lapply(malware, as.character), stringsAsFactors=T), "transactions")
summary(malware)
ar2 <- apriori(data = malware, parameter = list(minlen = 2, supp=0.001, conf = 0.3, target = "rules"))

summary(ar2)
inspect(ar2[1:10])

#      lhs                                                        rhs                            support     confidence lift       count                                                        
# [1]  {Census_InternalPrimaryDisplayResolutionVertical=480}   => {HasTpm=1}                     0.001001274 1.0000000  1.0008702  448
# [2]  {Census_InternalPrimaryDisplayResolutionVertical=480}   => {SMode=0}                      0.001001274 1.0000000  1.0004561  448
# [3]  {Census_InternalPrimaryDisplayResolutionHorizontal=640} => {HasTpm=1}                     0.001001274 1.0000000  1.0008702  448
# [4]  {Census_InternalPrimaryDisplayResolutionHorizontal=640} => {SMode=0}                      0.001001274 1.0000000  1.0004561  448
# [5]  {AvSigVersion=1.273.1702.0}                             => {AVProductsEnabled=1}          0.001001274 0.9977728  1.0175679  448
# [6]  {AvSigVersion=1.273.1702.0}                             => {HasTpm=1}                     0.001001274 0.9977728  0.9986411  448
# [7]  {AvSigVersion=1.273.1702.0}                             => {SMode=0}                      0.001001274 0.9977728  0.9982280  448
# [8]  {AvSigVersion=1.275.105.0}                              => {ï..EngineVersion=1.1.15200.1} 0.001005744 1.0000000  2.1923171  450
# [9]  {AvSigVersion=1.275.105.0}                              => {HasTpm=1}                     0.001005744 1.0000000  1.0008702  450
# [10] {AvSigVersion=1.275.105.0}                              => {SMode=0}                      0.001005744 1.0000000  1.0004561  450

malwarerules <- apriori(malware, 
                         parameter=list(support =0.001, confidence =0.5, minlen=2, maxlen=2), 
                         appearance = list(lhs=c("HasDetections=0", "HasDetections=1"), 
                                           default="rhs"))

inspect(malwarerules[1:15])
#      lhs                  rhs                                                      support   confidence lift      count 
# [1]  {HasDetections=0} => {SmartScreen=RequireAdmin}                               0.2761326 0.5568852  1.1243194 123550
# [2]  {HasDetections=0} => {Census_InternalPrimaryDisplayResolutionHorizontal=1366} 0.2511812 0.5065650  0.9946914 112386
# [3]  {HasDetections=0} => {Census_IsSecureBootEnabled=0}                           0.2555461 0.5153679  1.0064336 114339
# [4]  {HasDetections=0} => {Census_InternalPrimaryDisplayResolutionVertical=768}    0.2754084 0.5554248  1.0004861 123226
# [5]  {HasDetections=0} => {Census_ProcessorCoreCount=4}                            0.3003017 0.6056279  0.9831653 134364
# [6]  {HasDetections=0} => {SkuEdition=Home}                                        0.3140022 0.6332581  1.0128462 140494
# [7]  {HasDetections=0} => {AppVersion=4.18.1807.18075}                             0.2947791 0.5944902  0.9381037 131893
# [8]  {HasDetections=0} => {Census_MDC2FormFactor=Notebook}                         0.3151465 0.6355658  0.9919327 141006
# [9]  {HasDetections=0} => {Census_PrimaryDiskTypeName=HDD}                         0.3183694 0.6420655  0.9839985 142448
# [10] {HasDetections=0} => {AVProductsInstalled=1}                                  0.3138390 0.6329290  0.9039073 140421
# [11] {HasDetections=0} => {Wdft_IsGamer=0}                                         0.3613236 0.7286925  1.0384132 161667
# [12] {HasDetections=0} => {Census_IsTouchEnabled=0}                                0.4243345 0.8557688  0.9829229 189860
# [13] {HasDetections=0} => {Processor=x64}                                          0.4397358 0.8868290  0.9748877 196751
# [14] {HasDetections=0} => {Census_HasOpticalDiskDrive=0}                           0.4587399 0.9251552  1.0062552 205254
# [15] {HasDetections=0} => {Census_IsAlwaysOnAlwaysConnectedCapable=0}              0.4581722 0.9240103  0.9829504 205000

malwarerules1 <- apriori(malware, 
                        parameter=list(support =0.001, confidence =0.5, minlen=2, maxlen=2), 
                        appearance = list(lhs=c("HasDetections=1"), 
                                          default="rhs"))
inspect(malwarerules1[1:15])
#      lhs                  rhs                                                      support   confidence lift      count 
# [1]  {HasDetections=1} => {Census_InternalPrimaryDisplayResolutionHorizontal=1366} 0.2580873 0.5119275  1.0052213 115476
# [2]  {HasDetections=1} => {Census_IsSecureBootEnabled=0}                           0.2565273 0.5088331  0.9936723 114778
# [3]  {HasDetections=1} => {Census_InternalPrimaryDisplayResolutionVertical=768}    0.2797466 0.5548896  0.9995219 125167
# [4]  {HasDetections=1} => {Census_ProcessorCoreCount=4}                            0.3156963 0.6261975  1.0165577 141252
# [5]  {HasDetections=1} => {SkuEdition=Home}                                        0.3112241 0.6173267  0.9873652 139251
# [6]  {HasDetections=1} => {AppVersion=4.18.1807.18075}                             0.3389357 0.6722939  1.0608777 151650
# [7]  {HasDetections=1} => {Census_MDC2FormFactor=Notebook}                         0.3255884 0.6458188  1.0079346 145678
# [8]  {HasDetections=1} => {Census_PrimaryDiskTypeName=HDD}                         0.3341372 0.6627758  1.0157382 149503
# [9]  {HasDetections=1} => {AVProductsInstalled=1}                                  0.3863755 0.7663928  1.0945114 172876
# [10] {HasDetections=1} => {Wdft_IsGamer=0}                                         0.3404130 0.6752242  0.9622189 152311
# [11] {HasDetections=1} => {Census_IsTouchEnabled=0}                                0.4463022 0.8852601  1.0167961 199689
# [12] {HasDetections=1} => {Processor=x64}                                          0.4699372 0.9321411  1.0246991 210264
# [13] {HasDetections=1} => {Census_HasOpticalDiskDrive=0}                           0.4606642 0.9137478  0.9938478 206115
# [14] {HasDetections=1} => {Census_IsAlwaysOnAlwaysConnectedCapable=0}              0.4818653 0.9558011  1.0167690 215601
# [15] {HasDetections=1} => {IsProtected=1}                                          0.4877143 0.9674027  1.0119585 218218



















